---
title: "Habitat masks using ESA WorldCover"
output: 
  html_document:
    toc: yes
    toc_float: true
    number_sections: true
date: "`r Sys.Date()`"
---

The histograms were generated on Google Earth Engine (GEE), using the following script: https://code.earthengine.google.com/47055c8a1be42318e2a3817e35e1c8f3?noload=1

> WARNING: When the GEE script above is run on your internet browser, expect the browser to stall or hang for a few seconds at least. This is expected, while it sets up and initializes the several result exports the script calls for.

Load libraries.

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(geojsonsf)
library(sf)
```

# Read grid-wise histograms

Grid-wise histograms (column values are counts of 10mx10m pixels) were first generated on GEE state-wise. They were all then merged into a single GEOJSON, and duplicates were removed by column "`GRID_G1`" (to de-duplicate grids along borders between adjacent states), using QGIS. For this, the following tools in QGIS' Processing Toolbox were used: [Merge Vector Layers](https://docs.qgis.org/3.22/en/docs/user_manual/processing_algs/qgis/vectorgeneral.html#qgismergevectorlayers); [Delete duplicates by attribute](https://docs.qgis.org/3.22/en/docs/user_manual/processing_algs/qgis/vectorgeneral.html#qgisremoveduplicatesbyattribute).


```{r message=FALSE, warning=FALSE}
gridHists <- geojson_sf("data/histograms/wc2021GrdWiseNew25kmHist_AllStatesMerged.geojson") %>%
  rename(shrubland = freq_shrubland, woodland = freq_woodland,
         builtup = freq_builtup, grassland = freq_grassland,
         cropland = freq_cropland, bare = freq_bare,
         water = freq_water, mixed = freq_mixed,
         permafrost = freq_permafrost, savanna = freq_savanna,
         wetland = freq_wetland) %>% 
  mutate(
    across(c(shrubland, woodland, builtup, grassland, 
             cropland, bare, water, mixed, permafrost, 
             savanna, wetland), 
           as.numeric)) %>%
  replace(is.na(.), 0) %>% 
  mutate(
    totalArea = bare + builtup + cropland +
      woodland + grassland + mixed + permafrost +
      savanna + shrubland + water + wetland
  ) %>% 
  mutate(
    totalArea = if_else(totalArea == 0, area_sqkm/1e-4, totalArea) # 1e-4 sq km = 100 sq m
  )
# ggplot() +
#   geom_sf(data = gridHists, aes(fill=woodland)) +
#   theme_void()
```

# Proportions of habitat area

Convert pixel counts to proportion of grid's area.

***NOTE:** The column `area_sqkm` was generated from calcumations in the vector domain, and pixel counts in the other columns are from raster domain. These two approaches tend to yield slightly different values for areas. For calculation of proportions here, total area of grid is taken to be sum of pixel counts of all land covers, because of which proportions will be bounded between 0 and 1. Only when pixel counts of all land covers are 0 (eg. some atolls in Lakshadweep), total area is taken to be the area calculated in the vector domain.*


#### Habitat masks
Grid-scale masks are created for the following cover types:
* woodland
* open natural ecosystems: combines bare, grassland, shrubland, savanna
* cropland

```{r}
gridwiseHabPropAllSt_wc <- gridHists %>%
  # proportion of grid area
  mutate(
    across(c(bare, builtup, cropland, woodland, 
             grassland, mixed, permafrost, savanna, 
             shrubland, water, wetland),
           ~ .x/totalArea)) %>%
  # ONE as an omnibus class
  mutate(one = bare + grassland + shrubland + savanna) %>% 
  select(!c(totalArea, area_sqkm, layer,
            bare, grassland, shrubland, savanna, 
            builtup, mixed, water, wetland, permafrost))
```

# Rank grids by proportion of habitat in them

Grids are ranked by the proportion of cover types they have, so that top certain percentage of them can be used as their mask. Used ranking functions (help [here](https://dplyr.tidyverse.org/reference/ranking.html)).

```{r}
 gridwiseHabPropRankedAllSt_wc<- gridwiseHabPropAllSt_wc %>%
  mutate(
    woodlandReverseRank = order(order(woodland)),
    woodlandCumDist = cume_dist(woodland),
    oneReverseRank = order(order(one)),
    oneCumDist = cume_dist(one),
    croplandReverseRank = order(order(cropland)),
    croplandCumDist = cume_dist(cropland),
    )
```

To choose a meaningful value for selecting the masks, calculate proportion of each habitat type for all of India. Use this as as percent threshold in deciding the habitat masks.
```{r}
totalExtents <- gridHists %>% 
  mutate(one = bare + grassland + shrubland + savanna) %>% 
  summarise(sOne = sum(one), sWdl = sum(woodland), sCrp = sum(cropland), sTot = sum(totalArea))
propOne = totalExtents$sOne/totalExtents$sTot
propWdl = totalExtents$sWdl/totalExtents$sTot
propCrp = totalExtents$sCrp/totalExtents$sTot
```

# Create masks column and save

```{r}
gridwiseHabMaskAddedAllSt <- gridwiseHabPropRankedAllSt_wc %>% 
  mutate(
    maskWdl = if_else(woodlandCumDist > 1-propWdl, 1, 0),
    maskOne = if_else(     oneCumDist > 1-propOne, 1, 0),
    maskCrp = if_else(croplandCumDist > 1-propCrp, 1, 0)) %>% 
  select(GRID_G1, woodland, maskWdl, cropland, maskCrp, one, maskOne)

wdlNumCells <- gridwiseHabMaskAddedAllSt %>% filter(maskWdl == 1) %>% nrow()
crpNumCells <- gridwiseHabMaskAddedAllSt %>% filter(maskCrp == 1) %>% nrow()
oneNumCells <- gridwiseHabMaskAddedAllSt %>% filter(maskOne == 1) %>% nrow()

# does fraction of selected grids correspond to the percent thresholds? check.
wdlNumCells/nrow(gridwiseHabMaskAddedAllSt)
crpNumCells/nrow(gridwiseHabMaskAddedAllSt)
oneNumCells/nrow(gridwiseHabMaskAddedAllSt)
```

```{r}
st_write(gridwiseHabMaskAddedAllSt %>% st_as_sf(), "outputs/soibV2GridsIN_habMasksAdded.shp")
```

