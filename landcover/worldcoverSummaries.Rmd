---
title: "ESA WorldCover summary"
output: 
  html_document:
    toc: yes
    toc_float: true
    number_sections: true
---

The histograms are in files, separately by state, in [`/data/histograms`](data/histograms). They were generated on Google Earth Engine (GEE), using the script found here: https://code.earthengine.google.com/40cf6468594145e60818434b9c702ecd?noload=1

> WARNING: When the GEE script above is run on your internet browser, expect the browser to stall or hang for a few seconds at least. This is expected, while it sets up and initializes the several result exports the script calls for.

Load libraries.

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(geojsonsf)
library(broom)
library(geofacet)
library(sf)
```

# Grid-wise histograms

Grid-wise histograms are available as separate GEOJSON files of collections of grids by state in [`data/histograms`](data/histograms). 

They were all merged into a single GEOJSON, and duplicates were removed by column "`id`" (to de-duplicate grids along borders between adjacent states), using QGIS. For this, the following tools in QGIS' Processing Toolbox were used: [Merge Vector Layers](https://docs.qgis.org/3.22/en/docs/user_manual/processing_algs/qgis/vectorgeneral.html#qgismergevectorlayers); [Delete duplicates by attribute](https://docs.qgis.org/3.22/en/docs/user_manual/processing_algs/qgis/vectorgeneral.html#qgisremoveduplicatesbyattribute).

```{r message=FALSE, warning=FALSE}
gridwiseHistAllSt_wc <- geojson_sf("data/histograms/wc2020GrdWiseHist_AllStatesMerged.geojson") %>%
  mutate(
    across(c(shrubland, woodland, builtup, grassland, cropland, bare, water, mixed, permafrost, savanna, wetland),
           as.numeric)) %>%
  replace(is.na(.), 0) %>% 
  mutate(name = id)
gridwiseHistAllSt_igbp <- geojson_sf("data/histograms/modisIgbp2020GrdWiseHist.geojson") %>%
  mutate(
    across(c(shrubland, woodland, builtup, grassland, cropland, bare, water, mixed, permafrost, savanna, wetland),
           as.numeric)) %>%
  replace(is.na(.), 0) %>% 
  mutate(name = id)
gridwiseHistAllSt_cci <- geojson_sf("data/histograms/esaCci2020GrdWiseHist.geojson") %>%
  mutate(
    across(c(shrubland, woodland, builtup, grassland, cropland, bare, water, mixed, permafrost, savanna, wetland),
           as.numeric)) %>%
  replace(is.na(.), 0) %>% 
  mutate(name = id)

# ggplot() +
#     geom_sf(data = gridwiseHist_wc, aes(fill=woodland)) +
#     theme_void()
```

## Create grid for geofaceting

To make a figure with facetted plots for each grid where relative positions of grids are maintained, [`{geofacet}`](https://hafen.github.io/geofacet/index.html) is used. A grid of cells to hold the facets is generated here, according to [instructions in the package](https://hafen.github.io/geofacet/articles/geofacet.html#creating-your-own-grid-1).

```{r}
numCols <- 130
numGrids <- 17550

id <- seq(1, numGrids)
gridLabels <- as.data.frame(id) %>% 
  mutate(
    row = ceiling(id/numCols),
    col = ifelse(id %% numCols, id %% numCols, numCols),
    code = id)

gla <- gridwiseHistAllSt_wc %>%
  left_join(gridLabels, c("id")) %>%
  select(row, col, code, name) %>% 
  st_drop_geometry()

# grid_preview(gla)
```

## Proportions of area

Convert pixel counts to proportion of grid's area. Reshape. 

***NOTE:** The arithmetic here for calculating proportions is NOT 100% accurate, in the following way: the proportions in a grid don't add up to 1, but often go over 1 by a little bit. I (Pradeep) believe this is an artefact of the way proportions have been calculated below, which involves areas calculated in the vector-domain from high-res polygons of states and in the raster domain from pixel counts multiplied by area of a pixel. Mixing areas from these two approaches in arithmetic, particularly over large areas and with high-res vector features, is an invitation to disagreements in area values.*

*For the purposes of the goal here, of visualizing relative proportions in each SoIB grid, this disagreement is not a major problem. But this will warrant a closer and more careful handling if/when this feeds into the modeling framework.*

### WorldCover (10m/pixel)

```{r}
histGridTall_propOfAreas_wc = gridwiseHistAllSt_wc %>%
  mutate(across(c(bare, builtup, cropland, woodland, grassland, mixed, permafrost, savanna, shrubland, water, wetland), ~ .x*1e-4/area_sqkm)) %>% # pixel area = 100 sq. m = 1e-4 sq. km
  select(-area_sqkm) %>% 
  pivot_longer(
    cols = c(shrubland, woodland, builtup, grassland, cropland, bare, water, mixed, permafrost, savanna, wetland),
    names_to = "lc",
    values_to = "prop")
```

Visualize. Full image is [here](outputs/WorldcoverBasedLCsProportionOfAreas_gridwise_colFull.png) (**LARGE** file!).

```{r message=FALSE, warning=FALSE}
lcPal <- c("darksalmon", "firebrick", "violet", "darkgreen", "yellow", "mediumpurple", "lightgray", "limegreen", "orange", "navy", "dodgerblue")
bgColMatteBlack <- "#171717"
textCol <- "lightyellow"

histGridTall_propOfAreas_wc$lc <- as.factor(histGridTall_propOfAreas_wc$lc) %>% fct_relevel("woodland", after = 3)

pAreaProps <- ggplot(histGridTall_propOfAreas_wc %>% mutate(dummyX = 1)) +
  geom_col(aes(dummyX, prop, fill = lc, position = "stack")) +
  facet_geo(~ id, grid = gla) + 
  scale_y_continuous(n.breaks = 2) +
  theme_minimal() +
  theme(
    text = element_text(colour = textCol),
    title = element_text(size = 48),
    plot.subtitle = element_text(size = 36),
    plot.background = element_rect(fill = bgColMatteBlack),
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_blank()) +
  labs(
    title = "Area proportions of landcover types by grid cell",
    subtitle = "Using ESA WorldCover (10m/pixel) landcover map for 2020, with original classes remapped to bird-relevant classes",
    x = "\n",
    y = "Proportion of grid's area \n") +
  scale_fill_manual(
    values = lcPal, name = "Land cover type")

# pAreaProps
# ggsave("outputs/WorldcoverBasedLCsProportionOfAreas_gridwise_colFull.png",  plot = pAreaProps, width = 10000, height = 10000, units = "px", limitsize = FALSE)
```

### MODIS IGBP (500m/pixel)

```{r}
modisPixArea_sqkm <- 500*500/1e6
histGridTall_propOfAreas_igbp = gridwiseHistAllSt_igbp %>%
  mutate(across(c(bare, builtup, cropland, woodland, grassland, mixed, permafrost, savanna, shrubland, water, wetland), ~ .x*(modisPixArea_sqkm)/area_sqkm)) %>%
  select(-area_sqkm) %>% 
  pivot_longer(
    cols = c(shrubland, woodland, builtup, grassland, cropland, bare, water, mixed, permafrost, savanna, wetland),
    names_to = "lc",
    values_to = "prop")
```

Visualize. Full image is [here](outputs/MODISIGBPBasedLCsProportionOfAreas_gridwise_colFull.png).

```{r message=FALSE, warning=FALSE}
histGridTall_propOfAreas_igbp$lc <- as.factor(histGridTall_propOfAreas_igbp$lc) %>% fct_relevel("woodland", after = 3)

pAreaProps_igbp <- ggplot(histGridTall_propOfAreas_igbp %>% mutate(dummyX = 1)) +
  geom_col(aes(dummyX, prop, fill = lc, position = "stack")) +
  facet_geo(~ id, grid = gla) + 
  scale_y_continuous(n.breaks = 2) +
  theme_minimal() +
  theme(
    text = element_text(colour = textCol),
    title = element_text(size = 48),
    plot.subtitle = element_text(size = 36),
    plot.background = element_rect(fill = bgColMatteBlack),
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_blank()) +
  labs(
    title = "Area proportions of landcover types by grid cell",
    subtitle = "Using MODIS IGBP (500m/pixel) landcover map for 2020, with original classes remapped to bird-relevant classes",
    x = "\n",
    y = "Proportion of grid's area \n") +
  scale_fill_manual(
    values = lcPal, name = "Land cover type")

# pAreaProps
# ggsave("outputs/MODISIgbpBasedLCsProportionOfAreas_gridwise_colFull.png",  plot = pAreaProps_igbp, width = 10000, height = 10000, units = "px", limitsize = FALSE)
```

### ESA CCI (300m/pixel)

```{r}
esacciPixArea_sqkm <- 300*300/1e6
histGridTall_propOfAreas_cci = gridwiseHistAllSt_cci %>%
  mutate(across(c(bare, builtup, cropland, woodland, grassland, mixed, permafrost, savanna, shrubland, water, wetland), ~ .x*(esacciPixArea_sqkm)/area_sqkm)) %>%
  select(-area_sqkm) %>% 
  pivot_longer(
    cols = c(shrubland, woodland, builtup, grassland, cropland, bare, water, mixed, permafrost, savanna, wetland),
    names_to = "lc",
    values_to = "prop")
```

Visualize. Full image is [here](outputs/MODISIGBPBasedLCsProportionOfAreas_gridwise_colFull.png).

```{r message=FALSE, warning=FALSE}
histGridTall_propOfAreas_cci$lc <- as.factor(histGridTall_propOfAreas_cci$lc) %>% fct_relevel("woodland", after = 3)

pAreaProps_cci <- ggplot(histGridTall_propOfAreas_cci %>% mutate(dummyX = 1)) +
  geom_col(aes(dummyX, prop, fill = lc, position = "stack")) +
  facet_geo(~ id, grid = gla) + 
  scale_y_continuous(n.breaks = 2) +
  theme_minimal() +
  theme(
    text = element_text(colour = textCol),
    title = element_text(size = 48),
    plot.subtitle = element_text(size = 36),
    plot.background = element_rect(fill = bgColMatteBlack),
    axis.text.x = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_blank()) +
  labs(
    title = "Area proportions of landcover types by grid cell",
    subtitle = "Using ESA CCI (300m/pixel) landcover map for 2020, with original classes remapped to bird-relevant classes",
    x = "\n",
    y = "Proportion of grid's area \n") +
  scale_fill_manual(
    values = lcPal, name = "Land cover type")

# pAreaProps
# ggsave("outputs/ESACCIBasedLCsProportionOfAreas_gridwise_colFull.png",  plot = pAreaProps_cci, width = 10000, height = 10000, units = "px", limitsize = FALSE)
```

# State-wise histograms

Read histograms, merge.
```{r message=FALSE, warning=FALSE}
statewiseHist <- list.files(path = "data/histograms/", pattern = "*.csv", full.names = TRUE) %>% 
  map_df(~read_csv(., show_col_types = FALSE))
```
## Frequencies (raw pixel counts)

Reshape. 
```{r}
histTall = statewiseHist %>%
  select(-area_sqkm) %>% 
  replace(is.na(.), 0) %>% 
  pivot_longer(-ST_NM, names_to = "lc", values_to = "freq")
```


Visualize. Full image is [here](outputs/WorldcoverBasedLCsHistograms.jpg).
```{r}
histTall$lc <- as.factor(histTall$lc) %>% fct_relevel("woodland", after = 3)

pPixCounts <- ggplot() +
  geom_col(data = histTall, aes(lc, freq, fill = lc)) +
  scale_y_continuous(labels = label_number(suffix = "M", scale = 1e-6)) +
  facet_wrap(~ST_NM, scales = "free_y", labeller = label_wrap_gen()) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Frequencies of landcover types by state",
    subtitle = "Using ESA WorldCover (10m/pixel) landcover map for 2020, with original classes remapped to bird-relevant classes",
    x = "\n Land cover type",
    y = "Count of 10m pixels \n") +
  scale_fill_manual(
    values = c("darksalmon", "firebrick", "violet", "darkgreen", "yellow", "pink", "lightsteelblue", "lightgreen", "orange", "lightblue", "blue"), name = "Land cover type")

pPixCounts
# ggsave("outputs/WorldcoverBasedLCsHistograms.jpg",  plot = pPixCounts, width = 4000, height = 3000, units = "px", bg = "white")
```

## Proportions of area

Convert pixel counts to proportion of state's area. Reshape. 
```{r}
histTall_propOfAreas = statewiseHist %>%
  mutate(across(c(bare, builtup, cropland, woodland, grassland, mixed, permafrost, savanna, shrubland, water, wetland), ~ .x*1e-4/area_sqkm)) %>% # pixel area = 100 sq. m = 1e-4 sq. km
  select(-area_sqkm) %>% 
  replace(is.na(.), 0) %>% 
  pivot_longer(-ST_NM, names_to = "lc", values_to = "prop")
```

Visualize. Full image is [here](outputs/WorldcoverBasedLCsProportionOfAreas.jpg).
```{r}
histTall_propOfAreas$lc <- as.factor(histTall_propOfAreas$lc) %>% fct_relevel("woodland", after = 3)

pAreaProps <- ggplot() +
  geom_col(data = histTall_propOfAreas, aes(lc, prop, fill = lc)) +
  facet_wrap(~ST_NM, labeller = label_wrap_gen()) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.y = element_line(colour = "grey70", size = 0.2)) +
  labs(
    title = "Area proportions of landcover types by state",
    subtitle = "Using ESA WorldCover (10m/pixel) landcover map for 2020, with original classes remapped to bird-relevant classes",
    x = "\n Land cover type",
    y = "Proportion of state's area \n") +
  scale_fill_manual(
    values = c("darksalmon", "firebrick", "violet", "darkgreen", "yellow", "pink", "lightsteelblue", "lightgreen", "orange", "lightblue", "blue"), name = "Land cover type")

pAreaProps
# ggsave("outputs/WorldcoverBasedLCsProportionOfAreas.jpg",  plot = pAreaProps, width = 4000, height = 3000, units = "px", bg = "white")
```
